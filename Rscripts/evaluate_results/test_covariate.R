args <- (commandArgs(trailingOnly = TRUE))
for (i in 1:length(args)) {
  eval(parse(text = args[[i]]))
}

filterings <- strsplit(filterings, ",")[[1]]
datasets <- strsplit(datasets, ",")[[1]]
names(datasets) <- datasets

print(filterings)
print(pctkeep)
print(datasets)
print(datadir)
print(clusteringsummary)
#------------------------------------------------
# Test covariates
#------------------------------------------------
suppressPackageStartupMessages({
  
  library(dplyr)
  library(purrr)
  library(tidyr)
  library(SingleCellExperiment)
  library(ggplot2)
  
})
# load data
datasets_filtered <- c(outer(paste0(datadir, "/sce_filtered", filterings, pctkeep, "/sce_filtered", 
                                    filterings, pctkeep), 
                             paste0(datasets, ".rds"),
                             FUN = paste, sep = "_"))
names(datasets_filtered) <- gsub("\\.rds", "", basename(datasets_filtered))

datasets_full <- paste0(datadir, "/sce_full/sce_full_", datasets, ".rds")
names(datasets_full) <- gsub("\\.rds", "", basename(datasets_full))

all_data <- lapply(c(datasets_filtered, datasets_full), function(x) {
  readRDS(x)
})

# load summaries
res <- readRDS(file = clusteringsummary)
res <-  res %>%group_by(dataset, method,run) %>%
  mutate( cluster=as.numeric(cluster), truenclust=length(unique(trueclass) ))

# remove Seurat, k == truenclust
# what to do with the different runs(test all, conensus)? choose only one as starting point
res_filt <- res %>% filter( k==truenclust, run==1, !method %in% c("Seurat"))
# combine dataframes 
tbl <- do.call(rbind, lapply( names(all_data), function(nm) {
  x <- all_data[[nm]]
  colData <- colData(x) %>%
    as.data.frame() %>% 
    select( total_counts, total_features, pct_counts_top_50_features) %>%
    mutate(cell=row.names(.), dataset=nm )
}))

dd <- left_join(res_filt,tbl, by=c("cell", "dataset"))%>%select(-resolution) 
# nest dataframe, remove NA groups
d <- dd%>%group_by(dataset,method, k, run)%>%
  filter(any(!is.na(cluster))) %>%
  nest()
## test on total_features, total_counts
# functions for test with KW
kw.fun <- function(df){
  kruskal.test(formula=total_counts~cluster , data=df)
}
# extract pval
p_kw <- function(mod){
  mod$p.value
}
f <- d %>% mutate( model= map(data, kw.fun) ) %>% 
  transmute(dataset,method, p.value = map_dbl(model, p_kw))  %>%
  mutate(p.corr=p.adjust(p.value, "BH"))
# plot pvals
# format
f <- f%>%tidyr::separate(dataset, sep = "_", into = c("sce", "filtering", "dataset")) %>%
  dplyr::select(-sce)
# plot
ggplot2::ggplot(f,
                aes(x=method,y=p.corr)) +
  geom_point(aes(color=dataset),position="jitter") +
  #facet_grid(filtering~dataset, scales = "free" ) +
  geom_hline(yintercept=0.01 ) +
  #facet_grid(.~dataset) +
  theme(axis.text.x = element_text(angle=90))

